/*!
 * @package Restrict User Access
 * @author Joachim Jensen <jv@intox.dk>
 * @license GPLv3
 * @copyright 2018 by Joachim Jensen
 */
!function($){$.fn.select2.amd.define("select2/data/ruaAdapter",["select2/data/array","select2/data/minimumInputLength","select2/utils"],function(t,e,n){function s(t,e){s.__super__.constructor.call(this,t,e)}return n.Extend(s,t),s.prototype.query=function(t,e){t.term=t.term||"";var n=this.options.options,s=n.cachedResults[t.term];s?e({results:s}):(clearTimeout(n.searchTimer),n.searchTimer=setTimeout(function(){$.ajax({url:ajaxurl,data:{q:t.term,action:"rua/user/suggest",post_id:n.post_id},dataType:"JSON",type:"POST",success:function(s){for(var a=[],r=s.length-1;r>=0;r--)a.push({id:s[r].ID,text:s[r].user_login+" ("+s[r].user_email+")"});n.cachedResults[t.term]=a,e({results:a})}})},n.quietMillis))},n.Decorate(s,e)});var t={current_section:0,sections:[],init:function(){this.suggestUsers(),this.suggestPages(),this.toggleMembersTab(),this.tabController(),this.capController()},suggestPages:function(){var t=$(".js-rua-page"),e=t.data("rua-url");t.select2({theme:"wpca",minimumInputLength:0,closeOnSelect:!0,allowClear:!1,width:"100%",ajax:{delay:400,url:ajaxurl,data:function(t){return{search:t.term||"",action:"rua/page/suggest",paged:t.page||1}},dataType:"JSON",type:"POST",processResults:function(t,e){return{results:t,pagination:{more:!(t.length<20)}}}},createTag:function(t){var n=$.trim(t.term.replace(e,""));return""===n?null:{id:n,text:n,new:!0}},templateResult:function(t){return t.new?$("<span>").html("<b>Custom Link:</b> "+t.text):t.text}})},suggestUsers:function(){var t=$("#post_ID").val(),e=$(".js-rua-user-suggest");e.select2({theme:"wpca",cachedResults:{},quietMillis:400,searchTimer:null,post_id:t,placeholder:"Search for Users...",minimumInputLength:1,closeOnSelect:!0,allowClear:!1,width:"250",dataAdapter:$.fn.select2.amd.require("select2/data/ruaAdapter"),ajax:{},nextSearchTerm:function(t,e){return e},language:{noResults:function(){return WPCA.noResults},searching:function(){return WPCA.searching+"..."}}}).on("select2:selecting",function(t){e.data("forceOpen",!0)}).on("select2:close",function(t){e.data("forceOpen")&&(t.preventDefault(),e.select2("open"),e.data("forceOpen",!1))})},toggleMembersTab:function(){$("#rua-options .role").on("change","select",function(t){var e=""===$(this).val();$(".js-rua-tabs").find(".nav-tab").eq(1).toggle(e),$(".js-rua-drip-option").toggle(e),$(".duration").toggle(e)}),$("#rua-options .role select").change()},initTabSections:function(){$(".js-rua-tabs").find(".nav-tab").each(function(){var e=this.href.lastIndexOf("#");if(e>=0){var n=this.href.substr(e);t.sections.push(n),$(n).hide()}})},tabController:function(){this.initTabSections(),this.setCurrentSection(window.location.hash),$("#poststuff").on("click",".js-nav-link",function(e){t.setCurrentSection(this.href)})},findSectionByURL:function(t){var e=this.sections.indexOf(t.substring(t.lastIndexOf("#")));return e>=0?e:null},setCurrentSection:function(t){var e=this.findSectionByURL(t)||0,n=$(".js-rua-tabs").find(".nav-tab");n.eq(e).is(":visible")&&($(this.sections[this.current_section]).hide(),this.current_section=e,$(this.sections[this.current_section]).show(),n.removeClass("nav-tab-active"),n.eq(this.current_section).addClass("nav-tab-active"))},capController:function(){$(".rua-cb input").on("change",function(){var t=$(this),e=t.prop("checked"),n=$(".sum-"+t.val());n.text(parseInt(n.text())+1*(e?1:-1)),t.toggleClass("checked",e),e&&$("input[name='"+t.attr("name")+"']:checked").not(t).prop("checked",!1).trigger("change")}),$(".rua-cb input:checked").each(function(){var t=$(this),e=$(".sum-"+t.val());e.text(parseInt(e.text())+1),t.addClass("checked")})}};$(document).ready(function(){t.init()})}(jQuery);